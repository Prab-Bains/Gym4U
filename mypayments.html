<!doctype html>
<html lang="en">

<head>
    <link href="/images/logo_without_text.png" rel="icon" type="image/x-icon" />
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- Our Own CSS-->
    <link rel="stylesheet" type="text/css" href="./styles/my_style.css">

    <!-- Firebase 8 CDNs-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
        </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>

    <!-- Link to the api keys for your firebase project -->
    <script src="./scripts/firebaseAPI_DTC11.js"></script>

    <!-- Our own JS files-->
    <script src="./scripts/sidebarmenu.js"></script>

    <title>Gym4U</title>
</head>


<body>
    <!-- navbar-light bg-secondary -->
    <nav id="top_nav" class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a href="main.html"><img src="./images/logo_without_text.png" class="img-fluid" alt="logo"
                    style="width: 50px; height: 50px;"></a>

            <button class="btn btn-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight"
                aria-controls="offcanvasRight">&#9776;</button>

            <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight"
                aria-labelledby="offcanvasRightLabel">
                <div class="offcanvas-header">
                    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                        aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <div class="card">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><a href="profile.html">Profile</a></li>
                            <li class="list-group-item"><a href="listings.html">Listings</a></li>
                            <li class="list-group-item"><a href="appointments.html">Appointments</a></li>
                            <li class="list-group-item"><a href="help.html">Help</a></li>
                            <li class="list-group-item"><a id="signout">Sign Out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <button class="openBtn">Add Credit Card</button>
    <button class="btn" onClick="readCardList()">Refresh</button>

    <div class="cardlist_container" style="text-align: center;">
    </div>


    <div class="modal hidden">
        <div class="bg"></div>
        <div class="modalBox">
            <div class="px-4 py-5 my-5 text-center">
                <label for="floatingSelect">Gym list.</label>
                <select id="cardtype_id" aria-label="Floating label select example">
                    <option selected>Credit Card Type</option>
                    <option value="Visa">Visa</option>
                    <option value="MasterCard">MasterCard</option>
                    <option value="American Express">American Express</option>
                </select>
                <label for="creditcardno">Credit Card Number:</label>
                <input id="creditcardno_id" type="tel" inputmode="numeric" pattern="[0-9\s]{13,19}"
                    autocomplete="cc-number" maxlength="16" placeholder="xxxx xxxx xxxx xxxx" name="creditcardno"
                    required><br>
                <label for="cardname">Name on Card:</label>
                <input type="text" id="cardname_id" placeholder="Enter full name on card" name="cardname" required><br>
                <label for="expiry">Expiry Date:</label>
                <input type="date" id="expiry_id" name="expiry" required><br>
                <label for="cvv">CVV:</label>
                <input type="password" id="cvv_id" placeholder="cvv number" inputmode="numeric" pattern="[0-9]"
                    maxlength="3" name="cvv" required>
                <label for="billing">Billing Address:</label>
                <input type="text" id="billing_id" placeholder="Enter your billing address" width="100px" name="billing"
                    required>
                <button type="button" class="btn btn-lg px-4 gap-3" onClick="addCreditCard()">Save Card</button>
                <button class="closeBtn">âœ–</button>
            </div>
        </div>
    </div>

    <footer id="bottom_nav">
        <div>
            &#169; Gym4U
        </div>
    </footer>



    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous">

        </script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    -->

    <script>
        function addCreditCard() {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    var uid = user.uid
                    var currentDB = db.collection("creaditcards").doc(uid)
                    currentDB.get().then(doc => {
                        if (doc.exists) {
                            var appointment_list = doc.data();
                            let lengthOfAppointmentList = Object.keys(appointment_list).length + 1;
                            let cardType = document.getElementById("cardtype_id").value;
                            let creditcardno = document.getElementById("creditcardno_id").value;
                            let cardname = document.getElementById("cardname_id").value;
                            let expiryDate = document.getElementById("expiry_id").value;
                            let cvv = document.getElementById("cvv_id").value;
                            let billing = document.getElementById("billing_id").value;
                            let pointer = 'a' + lengthOfAppointmentList
                            let new_appointment_list = appointment_list;
                            let new_appointment_info = new Object({
                                card_type: cardType,
                                credit_card_no: creditcardno,
                                card_name: cardname,
                                expiry_date: expiryDate,
                                cvv_number: cvv,
                                billing_info: billing
                            });
                            new_appointment_list[pointer] = new_appointment_info;
                            currentDB.set(new_appointment_list);
                        } else {
                            let cardType = document.getElementById("cardtype_id").value;
                            let creditcardno = document.getElementById("creditcardno_id").value;
                            let cardname = document.getElementById("cardname_id").value;
                            let expiryDate = document.getElementById("expiry_id").value;
                            let cvv = document.getElementById("cvv_id").value;
                            let billing = document.getElementById("billing_id").value;
                            let new_appointment_info = new Object({
                                'a1':
                                {
                                card_type: cardType,
                                credit_card_no: creditcardno,
                                card_name: cardname,
                                expiry_date: expiryDate,
                                cvv_number: cvv,
                                billing_info: billing
                                }
                            });
                            currentDB.set(new_appointment_info);
                        }
                    })

                } else {
                    alert("no user sign-in");
                }
            })
            readCardList()
        }

        function readCardList() {
            $(".cardlist_container").empty();
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    var uid = user.uid
                    var currentDB = db.collection("creaditcards").doc(uid)
                    currentDB.get().then(doc => {
                        if (doc.exists) {
                            var appointment_list = doc.data();
                            const key_list = Object.keys(appointment_list);
                            let lengthOfAppointmentList = Object.keys(appointment_list).length;

                            for (var i = lengthOfAppointmentList; i > 0; i--) {
                                pointer = 'a' + i;
                                card_name = appointment_list[pointer]['card_name'];
                                card_type = appointment_list[pointer]['card_type'];
                                credit_card_no = appointment_list[pointer]['credit_card_no'];
                                cvv_number = appointment_list[pointer]['cvv_number'];
                                expiry_date = appointment_list[pointer]['expiry_date'];
                                billing_info = appointment_list[pointer]['billing_info'];
                                
                                var containerform =
                                    `<div class="card text-white bg-secondary mb-5" id="${pointer}" style="max-width: 18rem;">
                                        <div class="card-header" id="card_name_id_${pointer}">${card_name}</div>
                                            <div class="card-body">
                                                <input type="text" id="card_type_id_${pointer}" value="${card_type}">
                                                <input type="text" id="credit_card_no_id_${pointer}" value="${credit_card_no}">
                                                <input type="text" id="cvv_number_id_${pointer}" value="${cvv_number}">
                                                <input type="text" id="expiry_date_id_${pointer}" value="${expiry_date}">
                                                <input type="text" id="billing_info_id_${pointer}" value="${billing_info}">
                                                <button id="deleteButton_${pointer}" class="btn btn-secondary" onclick="removeCreditCard(this.id)">Remove</button>
                                                <button id="deleteButton_${pointer}" class="btn btn-secondary" onclick="UpdateAppointment(this.id)">Update</button>
                                            </div>
                                    </div>`;
                                $(".cardlist_container").append(containerform);
                            }
                        } else {
                            console.log("No such data")
                        }
                    })
                } else {
                    alert("no user sign-in");
                }
            })
        }
        readCardList();


        function removeCreditCard(id) {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    var uid = user.uid
                    var currentDB = db.collection("creaditcards").doc(uid)
                    var target_object_key = id.slice(-2);
                    currentDB.get().then(doc => {
                        var appointment_list = doc.data();
                        delete appointment_list[target_object_key];
                        let new_appointment_list = new Object({})
                        let lengthOfAppointmentList = Object.keys(appointment_list).length;
                        var i = 1
                        for (val in appointment_list) {
                            new_appointment_list['a'+i] = appointment_list[val] 
                            i++;      
                        }
                        console.log(new_appointment_list)
                        currentDB.set(new_appointment_list);
                    })
                    alert("Succesfully, remove appointment.")
                }
            })
        }

        function UpdateAppointment(id) {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    var uid = user.uid;
                    var currentDB = db.collection("creaditcards").doc(uid)
                    currentDB.get().then(doc => {
                        var target_object_key = id.slice(-2);
                        var appointment_list = doc.data();
                        let new_appointment_list = appointment_list;

                        var card_name_id = "card_name_id_" + id.slice(-2)
                        var card_type_id = "card_type_id_" + id.slice(-2)
                        var card_no_id = "credit_card_no_id_" + id.slice(-2)
                        var cvv_no_id = "cvv_number_id_" + id.slice(-2)
                        var expiry_date_id = "expiry_date_id_" + id.slice(-2)
                        var billing_id = "billing_info_id_" + id.slice(-2)

                        var card_name_value = $("#"+card_name_id).val();
                        var card_type_value = $("#"+card_type_id).val();
                        var card_no_value = $('#'+card_no_id).val();
                        var cvv_no_value = $('#'+cvv_no_id).val();
                        var expiry_date_value = $('#'+expiry_date_id).val();
                        var billing_value = $('#'+billing_id).val();

                        let appointment_info_object = new Object({
                                card_type: card_type_value,
                                credit_card_no: card_no_value,
                                card_name: card_name_value,
                                expiry_date: expiry_date_value,
                                cvv_number: cvv_no_value,
                                billing_info: billing_value
                        });
                        console.log(appointment_info_object);
                        new_appointment_list[target_object_key] = appointment_info_object;
                        currentDB.set(new_appointment_list);
                    })
                }
            })
        }

        const open = () => {
            document.querySelector(".modal").classList.remove("hidden");
        }
        const close = () => {
            document.querySelector(".modal").classList.add("hidden");
            readCardList();
        }

        document.querySelector(".openBtn").addEventListener("click", open);
        document.querySelector(".closeBtn").addEventListener("click", close);
        document.querySelector(".bg").addEventListener("click", close);


        // listener for the signout link
        document.getElementById("signout").addEventListener("click", logout);

    </script>

</body>

</html>