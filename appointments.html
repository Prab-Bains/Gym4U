<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- Firebase CSS -->
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />

    <!-- Firebase 8 CDNs-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
        </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>

    <!-- Link to the api keys for your firebase project -->
    <script src="scripts/firebaseAPI_DTC11.js"></script>

    <!-- Our Own CSS-->
    <link rel="stylesheet" type="text/css" href="./styles/my_style.css">

    <!-- Our own JS -->
    <script src="./scripts/sidebarmenu.js"></script>
    <title>Gym4U</title>
</head>

<body>
    <!-- navbar-light bg-secondary -->
    <nav id="top_nav" class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a href="main.html"><img src="./images/logo_without_text.png" class="img-fluid" alt="logo"
                    style="width: 50px; height: 50px;"></a>

            <button class="btn btn-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight"
                aria-controls="offcanvasRight">&#9776;</button>

            <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight"
                aria-labelledby="offcanvasRightLabel">
                <div class="offcanvas-header">
                    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                        aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <div class="card" style="width: 100%;">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><a href="profile.html">Profile</a></li>
                            <li class="list-group-item"><a href="listings.html">Listings</a></li>
                            <li class="list-group-item"><a href="#">Appointments</a></li>
                            <li class="list-group-item"><a href="help.html">Help</a></li>
                            <li class="list-group-item"><a id="signout">Sign Out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <div id="appointment_button_group" style="text-align: center;">
        <button class="btn btn-secondary" id="openBtn">Add appointment</button>
        <button class="btn btn-secondary" onClick="readAppointmentList()">Refresh</button>


    </div>
    <div class="appointment_container" style="text-align: center;">
    </div>


    <div class="modal hidden">
        <div class="bg"></div>
        <div class="modalBox">
            <div class="px-4 py-5 my-5 text-center">
                <label for="floatingSelect">Gym list.</label>
                <select id="id_gymname" class="form-select form-select-sm" aria-label="Floating label select example">
                    <option selected>Select one of gyms.</option>
                    <option value="Aiden's gym">Aiden's gym</option>
                    <option value="Prab's gym">Prab's gym</option>
                    <option value="Alissa's gym">Alissa's gym</option>
                </select>
                <label for="appt">Select a Start Time:</label>
                <input type="time" id="id_from_time" name="appt"><br>
                <label for="appt">Select a Start Time:</label>
                <input type="time" id="id_to_time" name="appt"><br>
                <label for="appt">Select a Date:</label>
                <input type="date" id="id_date" name="appt"><br>
                <button type="button" class="btn btn-secondary" onClick="addAppointment()">Add
                    appointment!</button>
                <button class="btn btn-secondary" id="closeBtn">âœ–</button>
            </div>
        </div>
    </div>
    <button onclick="moveToPage('a','b','c')">Hello, test.html</button>

    <footer id="bottom_nav">
        <div>
            &#169; Gym4U
        </div>
    </footer>

    <script>

        function moveToPage(id, detail, aim) {
            window.location.href = "test.html?id=" + id;
        }

        $("#panenl1").toggle(1000).toggle(1000)

        function removeAppointment(id) {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    var uid = user.uid
                    var currentDB = db.collection("appointments").doc(uid)

                    var date_id = "date_id_" + id.slice(-1)
                    var to_time_id = "to_time_id_" + id.slice(-1)
                    var from_time_id = "from_time_id_" + id.slice(-1)
                    var gym_name_id = "gym_name_id_" + id.slice(-1)

                    var date_value = $("#" + date_id).text();
                    var to_time_value = $("#" + to_time_id).text();
                    var from_time_value = $("#" + from_time_id).text();
                    var gym_name_id_value = $("#" + gym_name_id).text();

                    let appointment_info_object = new Object({
                        date: date_value,
                        start_time: from_time_value,
                        end_time: to_time_value,
                        gym_name: gym_name_id_value
                    });

                    currentDB.update({
                        appointment_list: firebase.firestore.FieldValue.arrayRemove(appointment_info_object)
                    })
                    alert("Succesfully, remove appointment.")
                }
            })
        }

        function addAppointment() {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    var uid = user.uid
                    var currentDB = db.collection("appointments").doc(uid)

                    let gymname = document.getElementById("id_gymname").value;
                    let from_time = document.getElementById("id_from_time").value;
                    let to_time = document.getElementById("id_to_time").value;
                    let date = document.getElementById("id_date").value;

                    let appointment_info_object = new Object({
                        date: date,
                        start_time: from_time,
                        end_time: to_time,
                        gym_name: gymname
                    });
                    currentDB.update({
                        appointment_list: firebase.firestore.FieldValue.arrayUnion(appointment_info_object)
                    })
                    alert("Succesfully, add appointment.")
                } else {
                    alert("no user sign-in");
                }
            })
        }

        function readAppointmentList() {
            $(".appointment_container").empty();
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    var uid = user.uid
                    var currentDB = db.collection("appointments").doc(uid)
                    currentDB.get()
                        .then(appointmentListdoc => {
                            var list = appointmentListdoc.data().appointment_list
                            for (let i = list.length - 1; i > -1; i--) {
                                date = list[i]["date"];
                                end_time = list[i]["end_time"];
                                start_time = list[i]["start_time"];
                                gym_name = list[i]["gym_name"];
                                var containerform =
                                    `<div class="card text-white bg-secondary mb-5" style="max-width: 18rem;">
                                        <div class="card-header" id="gym_name_id_${i}">${gym_name}</div>
                                            <div class="card-body">
                                                <h5 class="card-title">Date : </h5><h5 id="date_id_${i}">${date}</h5></h5>
                                                <p class="card-text">Start time : <span id="from_time_id_${i}">${start_time}</span></p>
                                                <p class="card-text">End time : <span id="to_time_id_${i}">${end_time}</span></p>
                                                <button id="deleteButton_${i}" class="btn btn-secondary" onclick="removeAppointment(this.id)">Remove</button>
                                            </div>
                                    </div>`;
                                $(".appointment_container").append(containerform);
                            }
                        })
                } else {
                    alert("no user sign-in");
                }
            })
        }
        readAppointmentList();

        const open = () => {
            document.querySelector(".modal").classList.remove("hidden");
        }
        const close = () => {
            document.querySelector(".modal").classList.add("hidden");
            readAppointmentList();
        }
        document.querySelector("#openBtn").addEventListener("click", open);
        document.querySelector("#closeBtn").addEventListener("click", close);
        document.querySelector(".bg").addEventListener("click", close);

        // listener for the signout link
        document.getElementById("signout").addEventListener("click", logout);
    </script>
</body>

</html>